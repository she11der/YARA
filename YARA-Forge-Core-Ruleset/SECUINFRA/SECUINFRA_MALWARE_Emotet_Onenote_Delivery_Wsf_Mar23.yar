rule SECUINFRA_MALWARE_Emotet_Onenote_Delivery_Wsf_Mar23
{
	meta:
		description = "Detects Microsoft OneNote files used to deliver Emotet (.wsf Payload)"
		author = "SECUINFRA Falcon Team (@SI_FalconTeam)"
		id = "a9201240-407d-5ca9-b7fd-37372a2e7d2a"
		date = "2023-03-16"
		modified = "2023-03-16"
		reference = "https://www.secuinfra.com/en/news/the-whale-surfaces-again-emotet-epoch4-spam-botnet-returns/"
		source_url = "https://github.com/SIFalcon/Detection/blob/2d7c66d7d16c7541bf2a9a83a7a6d334364a26fd/Yara/Malware/MALWARE_Emotet_OneNote_Delivery_wsf_Mar23.yar#L1-L33"
		license_url = "N/A"
		logic_hash = "ca48f5e694b18e3f0b89b0128817848a7d36f60d8a3ada522739849bf3f7126b"
		score = 75
		quality = 70
		tags = ""
		tlp = "CLEAR"
		hash0 = "dd9fcdcaf5c26fc27863c86aa65948924f23ab9faa261562cbc9d65ac80d33d4"
		hash1 = "ca2234b9c6f7c453b91a1ca10fc7b05487f94850be7ac5ea42986347d93772d8"
		hash2 = "b75681c1f99c4caf541478cc417ee9e8fba48f9b902c45d8bda0158a61ba1a2f"
		hash3 = "7c4591fd03b73ba6d0ec71a3cf89a04bfb4bd240d359117d96834a83727bdcc2"

	strings:
		$s_protected = "This document is protected" wide
		$s_click = "You have to double-click \"View\" button to open" wide
		$s_imgFileName = "Untitled picture.jpg" wide
		$script = "language=\"VBScript\""
		$wsfExt = ".wsf" ascii wide
		$GUIDwsf = {E7 16 E3 BD 65 26 11 45 A4 C4 8D 4D 0B 7A 9E AC ?? ?? ?? ?? ?? ?? ?? ?? 00 00 00 00 00 00 00 00 00 00 00 00 3C 6A 6F 62 20 69 64 3D 22}
		$endTmp = /rad.{5}\.tmp/

	condition:
		uint32be(0x0)==0xE4525C7B and any of ($s_*) and $script and $wsfExt and $GUIDwsf and $endTmp
}