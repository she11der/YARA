import "pe"

rule DITEKSHEN_MALWARE_Win_Dlagent03 : FILE
{
	meta:
		description = "Detects known Delphi downloader agent downloading second stage payload, notably from discord"
		author = "ditekSHen"
		id = "18493e3d-224f-5000-8e44-9ffda9c65cf0"
		date = "2024-01-23"
		modified = "2024-01-23"
		reference = "https://github.com/ditekshen/detection"
		source_url = "https://github.com/ditekshen/detection/blob/5fc671f9f4a5847c929d488dc74f8b671529b254/yara/malware.yar#L2732-L2753"
		license_url = "https://github.com/ditekshen/detection/blob/5fc671f9f4a5847c929d488dc74f8b671529b254/LICENSE.txt"
		logic_hash = "dea63edd48759fd04875e2eb8ac8b00ff801767f071337c667e31c15f0925cdc"
		score = 75
		quality = 50
		tags = "FILE"
		clamav_sig = "MALWARE.Win.Trojan.DLAgent03"

	strings:
		$delph1 = "FastMM Borland Edition" fullword ascii
		$delph2 = "SOFTWARE\\Borland\\Delphi" ascii
		$v1_1 = "InternetOpenUrlA" fullword ascii
		$v1_2 = "CreateFileA" fullword ascii
		$v1_3 = "WriteFile" fullword ascii
		$v2_1 = "WinHttp.WinHttpRequest.5.1" fullword ascii
		$v2_2 = { 6f 70 65 6e ?? ?? ?? ?? ?? 73 65 6e 64 ?? ?? ?? ?? 72 65 73 70 6f 6e 73 65 74 65 78 74 }
		$url1 = "https://discord.com/" fullword ascii
		$url2 = "http://www.superutils.com" fullword ascii
		$url3 = "http://www.xboxharddrive.com" fullword ascii

	condition:
		uint16(0)==0x5a4d and 1 of ($delph*) and 1 of ($url*) and ( all of ($v1*) or 1 of ($v2*))
}
