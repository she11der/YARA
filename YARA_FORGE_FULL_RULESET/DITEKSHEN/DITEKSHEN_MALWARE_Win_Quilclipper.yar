import "pe"

rule DITEKSHEN_MALWARE_Win_Quilclipper
{
	meta:
		description = "Detects QuilClipper variants mostly in memory or extracted AutoIt script"
		author = "ditekSHen"
		id = "bd23ec5a-f21a-5133-a77a-de2615933b82"
		date = "2024-01-23"
		modified = "2024-01-23"
		reference = "https://github.com/ditekshen/detection"
		source_url = "https://github.com/ditekshen/detection/blob/c37b067259715d4c93ac274a0830c54b355556a1/yara/malware.yar#L4076-L4094"
		license_url = "https://github.com/ditekshen/detection/blob/c37b067259715d4c93ac274a0830c54b355556a1/LICENSE.txt"
		logic_hash = "dcac93806a438b188ae70a679301cb6630b9eb6849bf8fbbb1cea5fed5e7cf75"
		score = 75
		quality = 75
		tags = ""

	strings:
		$cnc1 = "QUILCLIPPER by" ascii
		$cnc2 = "/ UserName:" ascii
		$cnc3 = "/ System:" ascii
		$s1 = "DLLCALL ( \"kernel32.dll\" , \"handle\" , \"CreateMutexW\" , \"struct*\"" ascii
		$s2 = "SHELLEXECUTE ( @SCRIPTFULLPATH , \"\" , \"\" , FUNC_" ascii
		$s3 = "CASE BITROTATE" ascii
		$s4 = "CASE BITXOR" ascii
		$s5 = "CLIP( FUNC_" ascii
		$s6 = "CLIPPUT (" ascii
		$s7 = "FUNC _CLIPPUTFILE(" ascii
		$s8 = "HKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Services\\Schedule" ascii

	condition:
		all of ($cnc*) or all of ($s*)
}
