import "pe"

rule DITEKSHEN_MALWARE_Win_Cobaltstrike : FILE
{
	meta:
		description = "CobaltStrike payload"
		author = "ditekSHen"
		id = "140e16d0-0102-5650-a371-c95013d7f021"
		date = "2024-01-23"
		modified = "2024-01-23"
		reference = "https://github.com/ditekshen/detection"
		source_url = "https://github.com/ditekshen/detection/blob/c37b067259715d4c93ac274a0830c54b355556a1/yara/malware.yar#L1845-L1864"
		license_url = "https://github.com/ditekshen/detection/blob/c37b067259715d4c93ac274a0830c54b355556a1/LICENSE.txt"
		logic_hash = "43513aef0ed715f0c214d7a14e465350f9c1bcadf87535e1c12561e976398bb3"
		score = 75
		quality = 50
		tags = "FILE"

	strings:
		$s1 = "%%IMPORT%%" fullword ascii
		$s2 = "www6.%x%x.%s" fullword ascii
		$s3 = "cdn.%x%x.%s" fullword ascii
		$s4 = "api.%x%x.%s" fullword ascii
		$s5 = "%s (admin)" fullword ascii
		$s6 = "could not spawn %s: %d" fullword ascii
		$s7 = "Could not kill %d: %d" fullword ascii
		$s8 = "Could not connect to pipe (%s): %d" fullword ascii
		$s9 = /%s\.\d[(%08x).]+\.%x%x\.%s/ ascii
		$pwsh1 = "IEX (New-Object Net.Webclient).DownloadString('http" ascii
		$pwsh2 = "powershell -nop -exec bypass -EncodedCommand \"%s\"" fullword ascii

	condition:
		uint16(0)==0x5a4d and (5 of ($s*) or ( all of ($pwsh*) and 2 of ($s*)) or (#s9>6 and 4 of them ))
}
