import "pe"

rule SIGNATURE_BASE_Oilrig_Malware_Campaign_Mal1 : FILE
{
	meta:
		description = "Detects malware from OilRig Campaign"
		author = "Florian Roth (Nextron Systems)"
		id = "c577f0ff-1a33-5d7f-93b2-27df8d414bce"
		date = "2016-10-12"
		modified = "2023-12-05"
		reference = "https://goo.gl/QMRZ8K"
		source_url = "https://github.com/Neo23x0/signature-base/blob/c04cde449bdf5fb40bb001fb663d32a70f89abe4/yara/apt_oilrig.yar#L69-L86"
		license_url = "https://github.com/Neo23x0/signature-base/blob/c04cde449bdf5fb40bb001fb663d32a70f89abe4/LICENSE"
		logic_hash = "b5fc4329bb639765890c49907860883b96d278381b83307c906f624e6645dedd"
		score = 75
		quality = 85
		tags = "FILE"
		license = "Detection Rule License 1.1 https://github.com/Neo23x0/signature-base/blob/master/LICENSE"
		hash1 = "e17e1978563dc10b73fd54e7727cbbe95cc0b170a4e7bd0ab223e059f6c25fcc"

	strings:
		$x1 = "DownloadExecute=\"powershell \"\"&{$r=Get-Random;$wc=(new-object System.Net.WebClient);$wc.DownloadFile(" ascii
		$x2 = "-ExecutionPolicy Bypass -File \"&HOME&\"dns.ps1\"" fullword ascii
		$x3 = "CreateObject(\"WScript.Shell\").Run Replace(DownloadExecute,\"-_\",\"bat\")" fullword ascii
		$x4 = "CreateObject(\"WScript.Shell\").Run DnsCmd,0" fullword ascii
		$s1 = "http://winodwsupdates.me" ascii

	condition:
		( uint16(0)==0x4f48 and filesize <4KB and 1 of them ) or (2 of them )
}
